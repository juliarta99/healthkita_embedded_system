<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule - Patient Medication</title>
    <style>
        :root {
            --primary-color: #57CC99;
            --text-color: #212121;
            --bg-color: #FBFBFB;
            --card-bg: #ffffff;
            --border-color: #e0e0e0;
            --success-color: #00b894;
            --warning-color: #ff9800;
            --danger-color: #ff6b6b;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; 
            background: var(--bg-color);
            padding: 20px;
        }
        
        .navbar {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
            padding-bottom: 10px;
        }
        
        .nav-link {
            font-size: 20px;
            color: #999;
            text-decoration: none;
            font-weight: 500;
            padding-bottom: 5px;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .nav-link.active {
            color: var(--text-color);
            border-bottom-color: var(--primary-color);
        }
        
        .top-actions {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 12px;
            z-index: 100;
        }
        
        .action-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(95, 201, 175, 0.3);
        }
        
        .action-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .patients-list {
            background: var(--primary-color);
            border-radius: 20px;
            padding: 25px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .list-header {
            margin-bottom: 15px;
        }
        
        .list-header h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-color);
        }
        
        .list-subtitle {
            font-size: 12px;
            color: rgba(45, 52, 54, 0.6);
        }
        
        .search-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 18px;
        }
        
        .search-bar {
            background: rgba(255, 255, 255, 0.3);
            padding: 10px 16px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }
        
        .search-bar input {
            background: none;
            border: none;
            color: var(--text-color);
            flex: 1;
            outline: none;
            font-size: 13px;
        }
        
        .search-bar input::placeholder {
            color: rgba(45, 52, 54, 0.5);
        }
        
        .filter-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 18px;
        }
        
        .filter-btn {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            color: var(--text-color);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .filter-btn.active {
            background: rgba(45, 52, 54, 0.7);
            color: white;
        }
        
        .patients-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: #f8f9fa;
        }
        
        th {
            padding: 14px 12px;
            text-align: left;
            font-size: 11px;
            font-weight: 600;
            color: #636e72;
            text-transform: capitalize;
        }
        
        td {
            padding: 14px 12px;
            font-size: 13px;
            border-top: 1px solid #f0f0f0;
            color: var(--text-color);
        }
        
        tbody tr {
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        tbody tr:hover {
            background: #f8f9fa;
        }
        
        tbody tr.active {
            background: #e8f5f0 !important;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: 500;
        }
        
        .status-badge.active {
            background: rgba(0, 184, 148, 0.1);
            color: var(--success-color);
        }
        
        .status-badge.completed {
            background: rgba(99, 110, 114, 0.1);
            color: #636e72;
        }
        
        .status-badge.pending {
            background: rgba(255, 152, 0, 0.1);
            color: var(--warning-color);
        }
        
        .status-badge.stopped {
            background: rgba(149, 165, 166, 0.1);
            color: #95a5a6;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-badge.active .status-dot {
            background: var(--success-color);
        }
        
        .status-badge.completed .status-dot {
            background: #636e72;
        }
        
        .status-badge.pending .status-dot {
            background: var(--warning-color);
        }
        
        .status-badge.stopped .status-dot {
            background: #95a5a6;
        }
        
        .action-btns {
            display: flex;
            gap: 8px;
        }
        
        .action-icon {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
            transition: transform 0.2s ease;
        }
        
        .action-icon:hover {
            transform: scale(1.2);
        }
        
        .time-badge {
            background: rgba(95, 201, 175, 0.1);
            color: var(--primary-color);
            padding: 4px 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
        }
        
        .diagnosis-tag {
            background: var(--bg-color);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            color: #666;
            display: inline-block;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 20px;
        }
        
        .pagination-btn {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            color: var(--text-color);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .pagination-btn:hover:not(:disabled) {
            background: rgba(45, 52, 54, 0.5);
            color: white;
        }
        
        .pagination-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .pagination-info {
            color: var(--text-color);
            font-size: 13px;
            font-weight: 500;
        }
        
        /* Modal for Edit/Delete confirmation */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: var(--card-bg);
            border-radius: 16px;
            max-width: 500px;
            width: 100%;
            padding: 24px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-color);
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
        }
        
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }
        
        .btn-danger {
            background: var(--danger-color);
            color: white;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning-color);
            color: white;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        @media (max-width: 1200px) {
            .top-actions {
                position: static;
                margin-bottom: 20px;
            }
        }
        
        @media (max-width: 768px) {
            .search-controls {
                flex-direction: column;
            }
            
            .filter-buttons {
                overflow-x: auto;
                white-space: nowrap;
            }
            
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 10px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="top-actions">
        <button class="action-btn" onclick="navigateToAddMedicine()">
            <span>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="20" height="20"><path fill="#ffff" d="M128 176C128 149.5 149.5 128 176 128C202.5 128 224 149.5 224 176L224 288L128 288L128 176zM64 176L64 464C64 525.9 114.1 576 176 576C237.9 576 288 525.9 288 464L288 358.2L404.3 527.7C439.8 579.4 509.6 592 560.3 555.8C611 519.6 623.3 448.3 587.8 396.6L459.3 209.3C423.8 157.6 354 145 303.3 181.2C297.7 185.2 292.6 189.6 288 194.3L288 176C288 114.1 237.9 64 176 64C114.1 64 64 114.1 64 176zM328.6 304.2C312.6 280.9 318.6 248.9 340.5 233.2C361.7 218.1 391 222.9 406.5 245.4L473.5 343L393.6 398.9L328.6 304.1z"/></svg>
            </span>
            <span>Add Medicine</span>
        </button>
        <button class="action-btn" onclick="navigateToAddPrescription()">
            <span>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="20" height="20"><path fill="#ffff" d="M128 128C128 92.7 156.7 64 192 64L341.5 64C358.5 64 374.8 70.7 386.8 82.7L493.3 189.3C505.3 201.3 512 217.6 512 234.6L512 512C512 547.3 483.3 576 448 576L192 576C156.7 576 128 547.3 128 512L128 128zM336 122.5L336 216C336 229.3 346.7 240 360 240L453.5 240L336 122.5zM288 344L288 384L248 384C239.2 384 232 391.2 232 400L232 432C232 440.8 239.2 448 248 448L288 448L288 488C288 496.8 295.2 504 304 504L336 504C344.8 504 352 496.8 352 488L352 448L392 448C400.8 448 408 440.8 408 432L408 400C408 391.2 400.8 384 392 384L352 384L352 344C352 335.2 344.8 328 336 328L304 328C295.2 328 288 335.2 288 344z"/></svg>
            </span>
            <span>Add Prescription</span>
        </button>
    </div>
    
    <div class="navbar">
        <a class="nav-link" onclick="navigateToDashboard()">Dashboard</a>
        <a class="nav-link active">Schedule</a>
        <a class="nav-link" onclick="navigateToMedicine()">Medicine</a>
        <a class="nav-link" onclick="navigateToReport()">Report</a>
    </div>
    
    <div class="patients-list">
        <div class="list-header">
            <h2>Medication Schedules</h2>
            <p class="list-subtitle">Manage and monitor all patient medication schedules</p>
        </div>
        
        <div class="search-controls">
            <div class="search-bar">
                <span>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="20" height="20"><path d="M480 272C480 317.9 465.1 360.3 440 394.7L566.6 521.4C579.1 533.9 579.1 554.2 566.6 566.7C554.1 579.2 533.8 579.2 521.3 566.7L394.7 440C360.3 465.1 317.9 480 272 480C157.1 480 64 386.9 64 272C64 157.1 157.1 64 272 64C386.9 64 480 157.1 480 272zM272 416C351.5 416 416 351.5 416 272C416 192.5 351.5 128 272 128C192.5 128 128 192.5 128 272C128 351.5 192.5 416 272 416z"/></svg>
                </span>
                <input type="text" id="searchInput" placeholder="Search by patient name, medicine, or diagnosis">
            </div>
        </div>
        
        <div class="filter-buttons">
            <button class="filter-btn active" data-filter="all" onclick="filterSchedules('all')">
                All Schedules
            </button>
            <button class="filter-btn" data-filter="active" onclick="filterSchedules('active')">
                Active
            </button>
            <button class="filter-btn" data-filter="completed" onclick="filterSchedules('completed')">
                Completed
            </button>
            <button class="filter-btn" data-filter="pending" onclick="filterSchedules('pending')">
                Pending
            </button>
            <button class="filter-btn" data-filter="stopped" onclick="filterSchedules('stopped')">
                Stopped
            </button>
        </div>
        
        <div class="patients-table">
            <table>
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Patient Name</th>
                        <th>Medicine Name</th>
                        <th>Status</th>
                        <th>Time</th>
                        <th>Diagnosis</th>
                        <th>Dose</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="scheduleTableBody">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>
        
        <div class="pagination">
            <button class="pagination-btn" onclick="changePage(-1)" id="prevBtn">◀</button>
            <span class="pagination-info" id="pageInfo">Page 1 of 1</span>
            <button class="pagination-btn" onclick="changePage(1)" id="nextBtn">▶</button>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title">Delete Schedule</h3>
                <button class="close-btn" onclick="closeDeleteModal()">x</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this medication schedule?</p>
                <p style="margin-top: 12px; color: #666; font-size: 14px;">
                    <strong id="deleteScheduleInfo"></strong>
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>
    
    <!-- Stop/Cancel Confirmation Modal -->
    <div class="modal-overlay" id="stopModal" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title">Stop Schedule</h3>
                <button class="close-btn" onclick="closeStopModal()">×</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to stop this medication schedule?</p>
                <p style="margin-top: 12px; color: #666; font-size: 14px;">
                    <strong id="stopScheduleInfo"></strong>
                </p>
                <p style="margin-top: 12px; color: #999; font-size: 13px;">
                    The schedule will be marked as stopped and will no longer send reminders.
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeStopModal()">Cancel</button>
                <button class="btn btn-warning" onclick="confirmStop()">Stop Schedule</button>
            </div>
        </div>
    </div>
    
    <script>
        // Get URL parameters and apply theme
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                primaryColor: params.get('primaryColor') || '#57CC99',
                textColor: params.get('textColor') || '#212121',
                backgroundColor: params.get('backgroundColor') || '#FBFBFB',
                cardBackground: params.get('cardBackground') || '#ffffff',
                borderColor: params.get('borderColor') || '#e0e0e0',
                successColor: params.get('successColor') || '#00b894',
                warningColor: params.get('warningColor') || '#ff9800',
                dangerColor: params.get('dangerColor') || '#ff6b6b',
                apiKey: params.get('apiKey')
            };
        }
        
        function applyTheme() {
            const params = getUrlParams();
            document.documentElement.style.setProperty('--primary-color', params.primaryColor);
            document.documentElement.style.setProperty('--text-color', params.textColor);
            document.documentElement.style.setProperty('--bg-color', params.backgroundColor);
            document.documentElement.style.setProperty('--card-bg', params.cardBackground);
            document.documentElement.style.setProperty('--border-color', params.borderColor);
            document.documentElement.style.setProperty('--success-color', params.successColor);
            document.documentElement.style.setProperty('--warning-color', params.warningColor);
            document.documentElement.style.setProperty('--danger-color', params.dangerColor);
        }
        
        // Sample schedule data
        const schedules = [
            { id: 1, patientId: 'patient1', patient: 'Wayan Bagus', medicine: 'Paracetamol', status: 'active', time: '09:00 AM', diagnosis: 'Hipertensi', dose: '1 Tablet' },
            { id: 2, patientId: 'patient2', patient: 'Bagus Wayan', medicine: 'Antasida', status: 'active', time: '11:00 AM', diagnosis: 'Diare', dose: '2 Tablet' },
            { id: 3, patientId: 'patient3', patient: 'Made Artha', medicine: 'Loperamide', status: 'completed', time: '09:00 AM', diagnosis: 'Hipertensi', dose: '500mg' },
            { id: 4, patientId: 'patient1', patient: 'Wayan Bagus', medicine: 'Domperidone', status: 'pending', time: '06:00 PM', diagnosis: 'Diare', dose: '10mg' },
            { id: 5, patientId: 'patient2', patient: 'Bagus Wayan', medicine: 'Paracetamol', status: 'active', time: '06:00 AM', diagnosis: 'Hipertensi', dose: '500mg' },
            { id: 6, patientId: 'patient3', patient: 'Made Artha', medicine: 'Amoxicillin', status: 'stopped', time: '09:00 PM', diagnosis: 'Infeksi', dose: '500mg' },
            { id: 7, patientId: 'patient1', patient: 'Wayan Bagus', medicine: 'Vitamin C', status: 'pending', time: '08:00 PM', diagnosis: 'Suplemen', dose: '1000mg' },
            { id: 8, patientId: 'patient2', patient: 'Bagus Wayan', medicine: 'Ibuprofen', status: 'completed', time: '02:00 PM', diagnosis: 'Nyeri', dose: '400mg' },
            { id: 9, patientId: 'patient3', patient: 'Made Artha', medicine: 'Cetirizine', status: 'active', time: '10:00 PM', diagnosis: 'Alergi', dose: '10mg' },
            { id: 10, patientId: 'patient1', patient: 'Wayan Bagus', medicine: 'Aspirin', status: 'active', time: '07:00 AM', diagnosis: 'Jantung', dose: '100mg' },
        ];
        
        let filteredSchedules = [...schedules];
        let currentFilter = 'all';
        let currentPage = 1;
        let itemsPerPage = 6;
        let deleteScheduleId = null;
        let stopScheduleId = null;
        
        // Render schedules
        function renderSchedules() {
            const tbody = document.getElementById('scheduleTableBody');
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageSchedules = filteredSchedules.slice(start, end);
            
            if (pageSchedules.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #999;">
                            No schedules found
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = pageSchedules.map((schedule, index) => `
                    <tr data-schedule-id="${schedule.id}">
                        <td>${start + index + 1}</td>
                        <td>${schedule.patient}</td>
                        <td>${schedule.medicine}</td>
                        <td>
                            <span class="status-badge ${schedule.status}">
                                <span class="status-dot"></span>
                                ${schedule.status === 'active' ? 'Active' : 
                                  schedule.status === 'completed' ? 'Completed' : 
                                  schedule.status === 'pending' ? 'Pending' : 'Stopped'}
                            </span>
                        </td>
                        <td><span class="time-badge">${schedule.time}</span></td>
                        <td><span class="diagnosis-tag">${schedule.diagnosis}</span></td>
                        <td>${schedule.dose}</td>
                        <td>
                            <div class="action-btns">
                                ${schedule.status !== 'stopped' && schedule.status !== 'completed' ? 
                                    `<button class="action-icon" onclick="stopSchedule(${schedule.id}, event)" title="Stop">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="20" height="20"><path fill="#ff6b6b" d="M320 576C461.4 576 576 461.4 576 320C576 178.6 461.4 64 320 64C178.6 64 64 178.6 64 320C64 461.4 178.6 576 320 576zM256 224L384 224C401.7 224 416 238.3 416 256L416 384C416 401.7 401.7 416 384 416L256 416C238.3 416 224 401.7 224 384L224 256C224 238.3 238.3 224 256 224z"/></svg>
                                    </button>` : ''}
                                <button class="action-icon" onclick="editSchedule(${schedule.id}, event)" title="Edit">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="20" height="20"><path fill="#ff9800" d="M416.9 85.2L372 130.1L509.9 268L554.8 223.1C568.4 209.6 576 191.2 576 172C576 152.8 568.4 134.4 554.8 120.9L519.1 85.2C505.6 71.6 487.2 64 468 64C448.8 64 430.4 71.6 416.9 85.2zM338.1 164L122.9 379.1C112.2 389.8 104.4 403.2 100.3 417.8L64.9 545.6C62.6 553.9 64.9 562.9 71.1 569C77.3 575.1 86.2 577.5 94.5 575.2L222.3 539.7C236.9 535.6 250.2 527.9 261 517.1L476 301.9L338.1 164z"/></svg>
                                </button>
                                <button class="action-icon" onclick="deleteSchedule(${schedule.id}, event)" title="Delete">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="20" height="20"><path fill="#ff6b6b" d="M232.7 69.9L224 96L128 96C110.3 96 96 110.3 96 128C96 145.7 110.3 160 128 160L512 160C529.7 160 544 145.7 544 128C544 110.3 529.7 96 512 96L416 96L407.3 69.9C402.9 56.8 390.7 48 376.9 48L263.1 48C249.3 48 237.1 56.8 232.7 69.9zM512 208L128 208L149.1 531.1C150.7 556.4 171.7 576 197 576L443 576C468.3 576 489.3 556.4 490.9 531.1L512 208z"/></svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }
            
            updatePagination();
            sendResize();
        }
        
        // Update pagination
        function updatePagination() {
            const totalPages = Math.ceil(filteredSchedules.length / itemsPerPage);
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages || totalPages === 0;
        }
        
        // Change page
        function changePage(direction) {
            const totalPages = Math.ceil(filteredSchedules.length / itemsPerPage);
            currentPage = Math.max(1, Math.min(totalPages, currentPage + direction));
            renderSchedules();
        }
        
        // Filter schedules
        function filterSchedules(filter) {
            currentFilter = filter;
            currentPage = 1;
            
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Apply filter
            if (filter === 'all') {
                filteredSchedules = [...schedules];
            } else {
                filteredSchedules = schedules.filter(s => s.status === filter);
            }
            
            // Apply search if exists
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (searchTerm) {
                applySearch(searchTerm);
            }
            
            renderSchedules();
        }
        
        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            currentPage = 1;
            applySearch(searchTerm);
            renderSchedules();
        });
        
        function applySearch(searchTerm) {
            const baseSchedules = currentFilter === 'all' 
                ? [...schedules] 
                : schedules.filter(s => s.status === currentFilter);
            
            if (searchTerm) {
                filteredSchedules = baseSchedules.filter(schedule => 
                    schedule.patient.toLowerCase().includes(searchTerm) ||
                    schedule.medicine.toLowerCase().includes(searchTerm) ||
                    schedule.diagnosis.toLowerCase().includes(searchTerm)
                );
            } else {
                filteredSchedules = baseSchedules;
            }
        }
        
        // Edit schedule
        function editSchedule(id, event) {
            if (event) event.stopPropagation();
            const schedule = schedules.find(s => s.id === id);
            if (schedule) {
                // Navigate to edit prescription page with schedule data
                sendMessage('navigate', { 
                    view: 'add-prescription', 
                    patientId: schedule.patientId,
                    scheduleId: id,
                    mode: 'edit'
                });
            }
        }
        
        // Delete schedule
        function deleteSchedule(id, event) {
            if (event) event.stopPropagation();
            const schedule = schedules.find(s => s.id === id);
            if (schedule) {
                deleteScheduleId = id;
                document.getElementById('deleteScheduleInfo').textContent = 
                    `${schedule.patient} - ${schedule.medicine} at ${schedule.time}`;
                document.getElementById('deleteModal').classList.add('active');
            }
        }
        
        function confirmDelete() {
            if (deleteScheduleId) {
                const index = schedules.findIndex(s => s.id === deleteScheduleId);
                if (index > -1) {
                    schedules.splice(index, 1);
                    filterSchedules(currentFilter);
                    closeDeleteModal();
                    
                    // Send delete event to parent
                    sendMessage('schedule-deleted', { scheduleId: deleteScheduleId });
                }
            }
        }
        
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
            deleteScheduleId = null;
        }
        
        // Stop schedule
        function stopSchedule(id, event) {
            if (event) event.stopPropagation();
            const schedule = schedules.find(s => s.id === id);
            if (schedule) {
                stopScheduleId = id;
                document.getElementById('stopScheduleInfo').textContent = 
                    `${schedule.patient} - ${schedule.medicine} at ${schedule.time}`;
                document.getElementById('stopModal').classList.add('active');
            }
        }
        
        function confirmStop() {
            if (stopScheduleId) {
                const schedule = schedules.find(s => s.id === stopScheduleId);
                if (schedule) {
                    schedule.status = 'stopped';
                    filterSchedules(currentFilter);
                    closeStopModal();
                    sendMessage('schedule-stopped', { scheduleId: stopScheduleId });
                }
            }
        }
        
        function closeStopModal() {
            document.getElementById('stopModal').classList.remove('active');
            stopScheduleId = null;
        }
        
        function closeModal(event) {
            if (event.target.id === 'deleteModal') {
                closeDeleteModal();
            } else if (event.target.id === 'stopModal') {
                closeStopModal();
            }
        }
        
        // Navigation functions
        function navigateToDashboard() {
            sendMessage('navigate', { view: 'dashboard' });
        }
        
        function navigateToAddMedicine() {
            sendMessage('navigate', { view: 'add-medicine' });
        }
        
        function navigateToAddPrescription() {
            sendMessage('navigate', { view: 'add-prescription' });
        }

        function navigateToMedicine() {
            sendMessage('navigate', { view: 'medicine' });
        }

        function navigateToReport() {
            sendMessage('navigate', { view: 'report' });
        }
        
        // Send message to parent
        function sendMessage(type, data) {
            window.parent.postMessage({ type, ...data }, '*');
        }
        
        // Send resize message
        function sendResize() {
            const height = Math.max(document.body.scrollHeight, 900);
            sendMessage('resize', { height });
        }
        
        // Initialize
        applyTheme();
        renderSchedules();
        setTimeout(sendResize, 100);
        new ResizeObserver(sendResize).observe(document.body);
    </script>
</body>
</html>